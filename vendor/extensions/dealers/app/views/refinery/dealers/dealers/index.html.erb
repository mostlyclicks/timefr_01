<section id="dealer-search">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>Find your nearest TIME dealer</h1>
        <% if Rails.env.development? %>
          <h1>DEALER INDEX</h1>
        <% end %>
        <%= form_tag refinery.dealers_dealers_path, method: 'get' do %>
        <div class="form-group">
        <%#= label_tag 'query', t('.search_label') %>
        <%= text_field_tag :search, {}, {type: "search", placeholder: t(".search_site_for"), value: (params[:search] if params[:search]), class: 'form-control input-lg'} %>
        </div>
        <%= select_tag :distance, options_for_select([[ "Select distance in miles", "10"],"50", "100", "250"], selected: "10"), class: 'form-control' %>
        <div class="checkbox input-lg">
        <%= check_box_tag :pedal_dealer, value = true, checked = false %><span>SHOW ME PEDAL DEALERS</span><%#= label_tag t('.search_pedal_dealers') %>
        </div>
        <%= submit_tag "SEARCH", class: "btn btn-success btn-lg" %>
        <% end %>

      </div>
    </div>
  </div>
</section>


<section id="results-message">
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <% if @results.blank? %>
          <h3><%= "We're sorry, there are no dealers near you: #{params[:search]}" %></h3>
          <p>Please try increasing the distance of your search area.</p>
        <% else %>
          <h3><%= "We found #{@results.count} TIME dealer(s) within #{params[:distance]} miles from your location (#{params[:search]})" %></h3>
          <%= content_for :dealer_list %>
          
        <% end %>
      </div>
    </div>
  </div>
</section>




<% content_for :dealer_list do %>
<% unless @results.blank? %>

 <div class="container">
  <div class="row">
  
    <div class="col-md-4 "> <!-- dealers -->
      <% @js_array =[] %>
      <% @results.each do |d| %>
      <!-- populate for gmap -->
      <% @collection = [d.dealer_name, d.latitude, d.longitude, d.street_address_1, d.street_address_2, d.city, d.state_province, d.postal_code, d.telephone_1, d.website] %>
      <% @js_array << @collection %>
      <!-- end populate for gmap -->

      <h4><%= d.dealer_name %></h4>
      <p class="lead"><%= d.street_address_1 %><br />
              <% unless d.street_address_2.blank? %>
                <%= d.street_address_2 %><br />
              <% end %>
            <%= d.city + ',' %> <%= d.state_province %> <%= d.postal_code %><br />
            <%= d.country %><br />
      
              TEL: <%= d.telephone_1 %><br />
              <% unless d.email.blank? %>
                <%= d.email %><br />
              <% end %>
              <% unless d.website.blank? %>
                <%= d.website %><br />
              <% end %> 
            <% end %></p>
    </div>
  
  <div class="col-md-8">
    <div id="map_us" style='width:100%; height: 800px;' class="maps"></div>
  </div>
  </div>
</div> 

<% else %>
Hey nothing here

<% end %>
<% end %>



<style>
  #map_us { -webkit-transform: translateZ(0) !important; }
</style>

<!-- <div class="container">
  <div class="col-md-10 col-md-offset-1">
    <div id="map_us" style="width:100% height: 800px;" class="maps">adfadfsdfd
    </div>
  </div>
</div> -->

<% @top_result = @js_array.first unless @js_array.blank? %>
<%#= @top_result[1] %>
<% unless @js_array.blank? %>
  <% @js_array.each do |j| %>
    <p><%= j[0] %>, <%= j[1] %>, <%= j[2] %></p>
  <% end %>
<% end %>

<script type="text/javascript">

function initMap() {
    var locations = <%= raw @js_array %>;

    var map = new google.maps.Map(document.getElementById('map_us'), {
      zoom: 9,
      center: new google.maps.LatLng(<%= raw @top_result[1] %>, <%= raw @top_result[2] %>),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    var marker, i;

    for (i = 0; i < locations.length; i++) {  
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(locations[i][1], locations[i][2]),
        map: map
      });    

      var contentString = '<strong>' + locations[i][0] + '</strong>' + '<br />' +
                          locations[i][3] + '<br />' +
                          locations[i][5] + ', ' + locations[i][6] + '<br />' +
                          locations[i][8] + '<br />' +
                          '<a href="http://' + locations[i][9] + '">' + locations[i][9] + '</a>';

      var infowindow = new google.maps.InfoWindow()

      google.maps.event.addListener(marker, 'click', (function(marker,contentString,infowindow) {
        return function() {
          infowindow.setContent(contentString);
          // infowindow.title = "Hey";
          infowindow.open(map, marker);
        }
      })(marker, contentString, infowindow));
    }
}

</script>

<%= content_for :map_js do %>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOn7yDGg8P2U61uzckRxdLLMD5_CkZuzY&callback=initMap&sensor=false"></script>
<% end %>





